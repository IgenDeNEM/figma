local currentState = 0

local nightTimerState = 6

local nightTimer = false

function setNightTimer()
    if nightTimerState == 6 then
        nightTimerState = 9
    elseif nightTimerState == 9 then
        nightTimerState = 6
    end
    setTrafficLightState(nightTimerState)
end


function changeTrafficLights()
    if currentState == 0 then
        currentState = 3
    elseif currentState == 3 then
        currentState = 0
    end
    setTrafficLightState(currentState)
    local realtime = getRealTime().hour
    if realtime < 22 then
        if isTimer(nightTimer) then
            killTimer(nightTimer)
        end
        setTimer(changeTrafficLightsOrange, 45000, 1)
    else
        nightTimer = setTimer(setNightTimer, 750, 0)
        setTrafficLightState(6)
    end
end

function changeTrafficLightsOrange()
    setTrafficLightState(6)
    setTimer(changeTrafficLights, 5000, 1)
end

setTrafficLightState(currentState)
changeTrafficLights()

function checkMorningReset()
    local realtime = getRealTime()
    local hour = realtime.hour
    local minute = realtime.minute

    if hour >= 9 and isTimer(nightTimer) then
        killTimer(nightTimer)
        nightTimer = false
        currentState = 0
        setTrafficLightState(currentState)
        changeTrafficLights()
    end
end

setTimer(checkMorningReset, 60000, 0)


addEvent("changeForRedLights", true)
addEventHandler("changeForRedLights", getRootElement(),
    function (upv1, lastTick)
        if isElement(source) and client and client == source then 
            if upv1 and lastTick then 
                local veh = getPedOccupiedVehicle(source)
                if veh and not getVehicleSirensOn(veh) and not getElementData(veh, "vehicle.sirenstate") then 
                    exports.sCore:takeMoney(source, 5000)
                end
            end
        end
    end 
)

local trafficLightCols = {}
-- noffy ♡ // HA POLYGONT CSINÁLSZ ELSŐ KETTŐ KOORDINÁTA A KÖZEPE
--San Fierro
--Sziváványzászlós [3855/GAY_TRAFFIC_LIGHT]
trafficLightCols[createColPolygon(-2539, 340, -2535.0146484375, 330.9541015625, -2544.08203125, 331.458984375, -2549.2412109375, 336.6455078125, -2549.44921875, 344.548828125, -2544.40234375, 349.583984375, -2535.884765625, 349.6005859375)] = true
trafficLightCols[createColPolygon(-2606, 327, -2611.2275390625, 318.29296875, -2601.615234375, 317.8720703125, -2602.0048828125, 338.201171875, -2611.244140625, 338.40234375, -2616.197265625, 333.20703125, -2616.341796875, 323.630859375)] = true
trafficLightCols[createColPolygon(-2606, 348, -2596.640625, 353.009765625, -2596.7109375, 343.2744140625, -2602.005859375, 338.2705078125, -2611.244140625, 338.46875, -2611.345703125, 358.3203125, -2602.13671875, 358.2978515625)] = true
trafficLightCols[createColPolygon(-2646, 288, -2642.0029296875, 278.041015625, -2651.177734375, 278.2197265625, -2656.9345703125, 283.63671875, -2657.1474609375, 292.93359375, -2636.6943359375, 292.9326171875, -2636.46875, 283.513671875)] = true
trafficLightCols[createColPolygon(-2646, 219, -2651.7919921875, 227.2998046875, -2656.1806640625, 222.63671875, -2656.2763671875, 212.57421875, -2637.46875, 212.9921875, -2637.3916015625, 222.3779296875, -2641.7841796875, 227.1510925293)] = true
trafficLightCols[createColPolygon(-2580, 226, -2587.525390625, 219.115234375, -2591.701171875, 228.177734375, -2574.67578125, 236.9189453125, -2570.568359375, 228.6484375, -2572.498046875, 221.21875, -2580.6826171875, 216.7578125)] = true
trafficLightCols[createColPolygon(-2562, 157, -2567.02734375, 167.296875, -2557.12890625, 167.537109375, -2551.9560546875, 162.3251953125, -2551.6142578125, 152.98046875, -2572.2265625, 153.02734375, -2572.1171875, 162.6513671875)] = true
trafficLightCols[createColPolygon(-2603, 157, -2594.375, 162.361328125, -2594.1484375, 152.958984375, -2599.75, 147.69140625, -2608.3359375, 147.7021484375, -2613.572265625, 153.0380859375, -2613.7919921875, 162.4814453125)] = true
--Hosszú [1284/MTRAFFIC2]
trafficLightCols[createColPolygon(-1525, 924, -1573.302734375, 905.83203125, -1516.279296875, 906.296875, -1515.9423828125, 943.38671875, -1572.7666015625, 943.4033203125)] = true
trafficLightCols[createColPolygon(632, -1400, 642.4228515625, -1415.7255859375, 622.6796875, -1415.6767578125, 617.5302734375, -1410.267578125, 617.4697265625, -1390.11328125, 622.6640625, -1385.0048828125, 642.23828125, -1384.9140625, 647.3515625, -1390.3095703125, 647.4892578125, -1410.541015625)] = true
trafficLightCols[createColPolygon(645, -1232, 637.921875, -1233.4326171875, 618.8125, -1235.9765625, 615.884765625, -1226.63671875, 610.45703125, -1226.57421875, 602.591796875, -1209.0673828125, 606.4501953125, -1202.3408203125, 615.0771484375, -1199.578125, 619.482421875, -1202.9736328125, 625.322265625, -1200.90234375, 643.84375, -1191.853515625, 654.5888671875, -1207.97265625, 642.1943359375, -1214.994140625, 637.1982421875, -1228.1220703125)] = true
--Álló [1350/CJ_TAFFIC_LIGHT4]
trafficLightCols[createColPolygon(-2790, -483, -2786.080078125, -497.947265625, -2776.8671875, -485.3388671875, -2796.720703125, -470.83203125, -2806.5849609375, -484.0654296875)] = true
trafficLightCols[createColPolygon(-2256, -69, -2247.0771484375, -60.68359375, -2264.8779296875, -60.513671875, -2269.6259765625, -65.4892578125, -2269.8447265625, -75.0712890625, -2264.7861328125, -79.904296875, -2247.109375, -80.111328125, -2242.3125, -74.8955078125, -2242.1611328125, -65.5068359375)] = true
--Los Santos
trafficLightCols[createColPolygon(1371, -939, 1352.8896484375, -946.8837890625, 1358.6064453125, -952.5224609375, 1382.3359375, -955.662109375, 1388.0595703125, -951.654296875, 1390.1015625, -931.9775390625, 1386.0361328125, -927.280273437, 1361.791015625, -923.826171875, 1355.974609375, -927.50390625)] = true
trafficLightCols[createColPolygon(1350, -1143 ,1332.84375, -1136.138671875, 1332.7822265625, -1154.126953125, 1337.88671875, -1163.84375, 1362.2626953125, -1163.3642578125, 1367.1298828125, -1145.7744140625, 1367.1494140625, -1135.8818359375, 1362.341796875, -1130.134765625, 1337.7568359375, -1129.6953125)] = true
trafficLightCols[createColPolygon(1849, -1180, 1835.1650390625, -1185.60546875, 1835.2333984375, -1176.0869140625, 1857.8466796875, -1176.0380859375, 1862.13671875, -1170.2646484375, 1871.447265625, -1170.453125, 1868.806640625, -1179.57421875, 1860.4736328125, -1185.890625, 1856.7041015625, -1191.3994140625, 1842.236328125, -1191.8935546875)] = true
trafficLightCols[createColPolygon(1849, -1463, 1841.8642578125, -1449.6484375, 1856.5830078125, -1449.4912109375, 1862.6640625, -1456.3603515625, 1862.8828125, -1470.45703125, 1856.63671875, -1477.337890625, 1842.2412109375, -1477.244140625, 1835.6044921875, -1465.5849609375, 1835.9541015625, -1456.0517578125)] = true
trafficLightCols[createColPolygon(2092, -1752, 2104.720703125, -1747.1943359375, 2103.888671875, -1757.234375, 2094.3720703125, -1762.5478515625, 2084.896484375, -1762.353515625, 2080.0048828125, -1757.115234375, 2083.572265625, -1747.513671875, 2090.75390625, -1741.572265625)] = true
trafficLightCols[createColPolygon(1961, -2166, 1951.6826171875, -2171.4814453125, 1951.39453125, -2161.8007812, 1956.9697265625, -2156.3544921875, 1966.2724609375, -2156.26953125, 1971.9453125, -2161.7353515625, 1971.8330078125, -2171.4033203125)] = true
trafficLightCols[createColPolygon(1763, -2171, 1774.85546875, -2161.8037109375, 1774.7255859375, -2171.3505859375, 1768.7919921875, -2176.130859375, 1759.26171875, -2176.0732421875, 1747.6708984375, -2171.10546875, 1747.390625, -2162.0439453125)] = true
trafficLightCols[createColPolygon(1763, -2194, 1759.1123046875, -2185.0009765625, 1768.587890625, -2185.001953125, 1774.505859375, -2190.208984375, 1774.9091796875, -2199.3203125, 1753.740234375, -2199.6279296875, 1754.396484375, -2190.05859375)] = true
--Egyéb
trafficLightCols[createColPolygon(145, -1565, 166.3349609375, -1567.95703125, 149.21875, -1585.625, 137.6708984375, -1582.880859375, 130.748046875, -1576.7529296875, 131.5751953125, -1570.0771484375, 125.615234375, -1565.0634765625, 139.3095703125, -1544.4326171875, 149.21484375, -1546.0263671875, 163.8671875, -1558.931640625)] = true
trafficLightCols[createColPolygon(794, -1048, 800.0927734375, -1064.134765625, 790.1328125, -1063.736328125, 783.1923828125, -1058.5927734375, 780.1689453125, -1039.9912109375, 790.2353515625, -1033.970703125, 799.783203125, -1033.57421875, 805.57421875, -1039.001953125, 809.6298828125, -1057.5029296875)] = true
trafficLightCols[createColRectangle(1816.7568359375, -1762.3857421875, 10.384765625, 39.5283203125)] = true
trafficLightCols[createColRectangle(1331.2861328125, -1425.771484375, 35.40234375, 45.51171875)] = true
trafficLightCols[createColPolygon(646.6142578125, -1723.7578128, 646.6142578125, -1723.7578128, 609.7626953125, -1717.3603510281, 607.8173828125, -1731.5439454463, 643.0947265625, -1738.22070322)] = true
trafficLightCols[createColPolygon(-2521.626953125, 553.374023437, -2516.5166015625, 558.599609375, -2516.421875, 573.33203125, -2521.7890625, 578.15234375, -2531.7939453125, 578.1513671875, -2536.7109375, 573.12304687, -2536.634765625, 558.2001953125, -2531.4638671875, 553.2451171875)] = true
--Bayside
trafficLightCols[createColPolygon(-2751, 2352, -2727.205078125, 2367.88671875, -2722.34765625, 2346.9609375, -2728.2685546875, 2338.427734375, -2769.1142578125, 2329.9970703125, -2775.994140625, 2365.931640625, -2734.466796875, 2373.7138671875)] = true
--San Fierro
trafficLightCols[createColPolygon(-1799, -115, -1804.0400390625, -105.7294921875, -1794.2099609375, -105.8818359375, -1788.5224609375, -111.9951171875, -1788.658203125, -121.134765625, -1794.423828125, -126.802734375, -1803.8095703125, -126.7373046875, -1809.9033203125, -121.0224609375, -1810.0458984375, -111.482421875)] = true

addEvent("requestTrafficColshapes", true)
addEventHandler("requestTrafficColshapes", root, function()
    if client and client == source then
        triggerClientEvent(client, "gotTrafficColshapes", client, trafficLightCols)
    end
end)